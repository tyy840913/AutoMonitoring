name: Multi-Repo Update Checker (Including Pre-releases)

on:
  # æ¯å°æ—¶çš„ç¬¬0åˆ†é’Ÿè¿è¡Œä¸€æ¬¡
  schedule:
    - cron: '0 6-23 * * *'
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

permissions:
  contents: write

jobs:
  check_for_updates:
    runs-on: ubuntu-latest
    strategy:
      # ä¸ºäº†é¿å…ä¸€ä¸ªä»“åº“çš„å¤±è´¥å½±å“å…¶ä»–ä»“åº“ï¼Œè®¾ç½® fail-fast: false
      fail-fast: false
      matrix:
        repo:
          - 'bia-pain-bache/BPB-Worker-Panel'
          - 'KaringX/karing'
          
          # --- åœ¨è¿™é‡Œæ·»åŠ æ›´å¤šä½ æƒ³è¦ç›‘æ§çš„ä»“åº“ï¼Œæ ¼å¼ä¸º 'owner/repo-name' ---

    steps:
      - name: 1. åˆå§‹åŒ–ä»“åº“
        uses: actions/checkout@v4

      - name: 2. å‡†å¤‡ç‰ˆæœ¬æ–‡ä»¶è·¯å¾„
        id: paths
        run: |
          mkdir -p _versions
          VERSION_FILE="_versions/$(echo ${{ matrix.repo }} | tr '/' '-').version"
          echo "VERSION_FILE=${VERSION_FILE}" >> $GITHUB_ENV
          echo "Checking repo: ${{ matrix.repo }}"
          echo "Version file will be: ${VERSION_FILE}"

      - name: 3. è·å–æœ¬åœ°è®°å½•çš„æœ€æ–°ç‰ˆæœ¬
        id: get_local_version
        run: |
          if [ -f "${{ env.VERSION_FILE }}" ]; then
            LOCAL_VERSION=$(cat "${{ env.VERSION_FILE }}")
            echo "æœ¬åœ°è®°å½•çš„ç‰ˆæœ¬ (${{ matrix.repo }}): ${LOCAL_VERSION}"
          else
            LOCAL_VERSION="<none>"
            echo "é¦–æ¬¡æ£€æŸ¥ (${{ matrix.repo }}), æ— æœ¬åœ°ç‰ˆæœ¬è®°å½•ã€‚"
          fi
          echo "LOCAL_VERSION=${LOCAL_VERSION}" >> $GITHUB_ENV

      - name: 4. ä» GitHub API è·å–è¿œç¨‹æœ€æ–°å‘å¸ƒç‰ˆæœ¬
        id: get_remote_version
        run: |
          # --- æ ¸å¿ƒä¿®æ”¹ç‚¹ START ---
          # ä½¿ç”¨ /releases API è·å–æ‰€æœ‰ç‰ˆæœ¬çš„åˆ—è¡¨
          API_URL="https://api.github.com/repos/${{ matrix.repo }}/releases"
          
          # è·å–åŒ…å«æ‰€æœ‰ release çš„ JSON æ•°ç»„ï¼Œç„¶åç”¨ jq å–ç¬¬ä¸€ä¸ªå…ƒç´ 
          RESPONSE=$(curl -fsL --header "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" "$API_URL" | jq '.[0]')
          # --- æ ¸å¿ƒä¿®æ”¹ç‚¹ END ---

          # å¦‚æœ RESPONSE æ˜¯ null æˆ–ç©ºå­—ç¬¦ä¸²ï¼Œè¯´æ˜ä»“åº“å¯èƒ½æ²¡æœ‰ä»»ä½• release
          if [ -z "$RESPONSE" ] || [ "$RESPONSE" == "null" ]; then
            echo "æ— æ³•è·å–ä»“åº“ ${{ matrix.repo }} çš„ä»»ä½• Release ä¿¡æ¯ã€‚å¯èƒ½è¯¥ä»“åº“ä»æœªå‘å¸ƒè¿‡ã€‚"
            echo "REMOTE_VERSION=FETCH_FAILED" >> $GITHUB_ENV
            exit 0
          fi

          REMOTE_VERSION=$(echo "$RESPONSE" | jq -r '.tag_name')
          RELEASE_URL=$(echo "$RESPONSE" | jq -r '.html_url')
          # æ£€æŸ¥æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆï¼Œç”¨äºé€šçŸ¥
          IS_PRERELEASE=$(echo "$RESPONSE" | jq -r '.prerelease')

          echo "è¿œç¨‹æœ€æ–°å‘å¸ƒç‰ˆæœ¬ (${{ matrix.repo }}): ${REMOTE_VERSION} (Prerelease: ${IS_PRERELEASE})"
          echo "REMOTE_VERSION=${REMOTE_VERSION}" >> $GITHUB_ENV
          echo "RELEASE_URL=${RELEASE_URL}" >> $GITHUB_ENV
          echo "IS_PRERELEASE=${IS_PRERELEASE}" >> $GITHUB_ENV


      - name: 5. æ¯”è¾ƒç‰ˆæœ¬å¹¶å†³å®šæ˜¯å¦é€šçŸ¥
        id: check_if_updated
        if: steps.get_remote_version.outputs.REMOTE_VERSION != 'FETCH_FAILED'
        run: |
          if [ "${{ env.LOCAL_VERSION }}" != "${{ env.REMOTE_VERSION }}" ]; then
            echo "å‘ç°æ–°ç‰ˆæœ¬! (${{ matrix.repo }}) ä» ${{ env.LOCAL_VERSION }} -> ${{ env.REMOTE_VERSION }}"
            echo "UPDATE_FOUND=true" >> $GITHUB_ENV
          else
            echo "ç‰ˆæœ¬æœªæ›´æ–° (${{ matrix.repo }}), æ— éœ€æ“ä½œã€‚"
            echo "UPDATE_FOUND=false" >> $GITHUB_ENV
          fi

      - name: 6. å‘é€ Telegram é€šçŸ¥
        if: env.UPDATE_FOUND == 'true'
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          format: markdown
          message: |
            ğŸ“¢ *ä»“åº“æ›´æ–°æé†’*
            ${{ env.IS_PRERELEASE == 'true' && '**(è¿™æ˜¯ä¸€ä¸ªé¢„å‘å¸ƒç‰ˆæœ¬!)**' || '' }}

            *ä»“åº“:* `${{ matrix.repo }}`
            *æ—§ç‰ˆæœ¬:* `${{ env.LOCAL_VERSION }}`
            *æ–°ç‰ˆæœ¬:* `${{ env.REMOTE_VERSION }}`

            ğŸ‘‡ *ç‚¹å‡»æŸ¥çœ‹æ–°ç‰ˆæœ¬è¯¦æƒ…:*
            [${{ env.REMOTE_VERSION }} Release Notes](${{ env.RELEASE_URL }})

      - name: 7. æ›´æ–°æœ¬åœ°ç‰ˆæœ¬è®°å½•æ–‡ä»¶
        if: env.UPDATE_FOUND == 'true'
        run: |
          echo "æ­£åœ¨æ›´æ–°ç‰ˆæœ¬æ–‡ä»¶: ${{ env.VERSION_FILE }}"
          echo "${{ env.REMOTE_VERSION }}" > "${{ env.VERSION_FILE }}"

      - name: 8. æäº¤ç‰ˆæœ¬æ–‡ä»¶å˜æ›´
        if: env.UPDATE_FOUND == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ci: æ›´æ–° ${{ matrix.repo }} ç‰ˆæœ¬è®°å½•è‡³ ${{ env.REMOTE_VERSION }}"
          file_pattern: ${{ env.VERSION_FILE }}
          commit_author: "github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>"
